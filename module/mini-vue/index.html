<html lang="zh">
  <head>
    <title>Mini Vue Demo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body style="margin: 0;">
    <p
      style="
        display: -webkit-box;
        margin: 0;
        padding: 0.5em;
        background: #eee;
        color: #cacaca;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 4;
        overflow: hidden;
        user-select: none;
        word-break: break-all;
        line-height: 1.5;
        font-size: 12px;
        letter-spacing: 1px;
      "
    >
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
      <span>MiniVueMiniVueMiniVueMiniVueMiniVue</span>
    </p>
    <div id="app"></div>
  </body>
  <script>
    const Vue = module

    function dedent (str) {
      const minCount = Math.min.apply(null, str
        .match(/(\r?\n)(\s+)/g)
        .map(x => x.slice(1))
        .map(x => x.length)
      )
      return str.replace(new RegExp(`(\\r?\\n)(\\s{${minCount}})`, 'g'), '$1')
    }

    let sectionCount = 1
    let tick = null
    let task = []
    function createSection (msg, vue, pre, titleTag = 'h2') {
      const $app = document.querySelector('#app')
      const $content = document.createElement('div')
      const $vmount = document.createElement('div')
      const $title = document.createElement(titleTag)

      $content.setAttribute('class', `section-content-${sectionCount++}`)
      $title.innerText = msg

      $app.appendChild($content)
      $content.appendChild($title)
      $content.appendChild($vmount)
      vue  && vue.$mount($vmount)
      if (pre) {
        const $pre = document.createElement('pre')
        $pre.innerText = pre ? dedent(String(pre)) : ''
        $content.appendChild($pre)
      }

      return vue
    }
    function test (fn, isImportant = false) {
      isImportant
        ? task.unshift(fn)
        : task.push(fn)
      if (!tick) {
        tick = Promise.resolve().then(() => {
          task.map(fn => task.includes(fn) && fn())
          task = []
          tick = null
        })
      }
    }
    function only (fn) {
      test(() => {
        fn()
        task = []
      }, true)
    }

    window.onload = () => {

      createSection('E2E Test Cases', undefined, undefined, 'h1')

      test(function () {
        createSection('# multy root template', new Vue({
          template: `
            <!-- hello comment -->
            <div><h5>Root NO. 1</h5> <dd><dt>first line</dt><dt>second line</dt><dt>third line</dt></dd></div>
            <div><h5>Root NO. 2</h5> <dd><dt>first line</dt><dt>second line</dt><dt>third line</dt></dd></div>
            <div><h5>Root NO. 3</h5> <dd><dt>first line</dt><dt>second line</dt><dt>third line</dt></dd></div>
          `
        }), arguments.callee)
      })

      test(function () {
        const vue = createSection('# template value binding', new Vue({
          template: `
            <div>Count: {{ count }}</div>
            <div>Another Count: {{ this.count }}</div>
          `,
          data () { return { count: 990 } }
        }), arguments.callee)
        setInterval(() => vue.count += 1, 1000)
      })

      test(function () {
        const vue = createSection('# DOM prop binding', new Vue({
          template: `
            <p>Switch Result: {{ switchValue }}</p>
            <button :disabled="!switchValue">{{ switchValue ? 'button' : 'disabled' }}</button>
            <button :disabled="switchValue">{{ !switchValue ? 'button' : 'disabled' }}</button>
          `,
          data () { return { switchValue: true } }
        }), arguments.callee)
        setInterval(() => vue.switchValue  = !vue.switchValue, 2000)
      })

      test(function () {
        const vue = createSection('# DOM event', new Vue({
          template: `
            <p>Count Result: {{ count }}</p>
            <p>Click "+" to add 1, "-" to dec 1.</p>
            <button @click="() => count++">+</button>
            <button @click="() => count--">-</button>
          `,
          data () { return { count: 1 } }
        }), arguments.callee)
      })

      test(function () {
        const vue = createSection('# method binding', new Vue({
          template: `
            <button :disabled="disabled">button</button>
            <button @click="disableFirstButton">disabled the first button for one second</button>
          `,
          data () {
            return {
              disabled: false
            }
          },
          methods: {
            disableFirstButton () {
              if (!this.disabled) {
                this.disabled = true
                setTimeout(() => this.disabled = false, 1000)
              }
            }
          }
        }), arguments.callee)
      })

      only(function () {
        const vue = createSection('# watch', new Vue({
          template: `
            <p>Count Result: {{ count }}</p>
            <p>Button Pressed: {{ buttonClickCount }} times</p>
            <button @click="() => count++">+</button>
            <button @click="() => count--">-</button>
          `,
          data () {
            return {
              count: 1,
              buttonClickCount: 0
            }
          },
          watch: {
            count (newValue, oldValue) {
              this.buttonClickCount += 1
            }
          }
        }), arguments.callee)
      })
    }
  </script>
</html>
